<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>聊天室</title>
</head>
<body>
    
<script src="assets/js/jquery.min.js"></script>
<h1>欢迎来到聊天室</h1>
<hr>
<div id="loginpart">
<font>还未登录？ 请先登录</font>
<br>
用户名：<input type="text" id="userName">
<br>
<input type="button" id="btnlogin" value="登录">
</div>
<hr>
<!-- 聊天板 -->
<div id="content">

</div>
<!-- 聊天板末尾 -->
<hr>
<!-- 输入框 -->
<div>
	<input type="text" length=20 id="word"><input type="button" id="btnsend"  value="发送">
	<br>
	<input type="button" value="退出" id="logout">
</div>
<script type="text/javascript">
    var socket;
    if(typeof(WebSocket) == "undefined") {
        alert("您的浏览器不支持WebSocket");
    }

    //初始化 加载
    window.onload=function(){  
    	//实现化WebSocket对象，指定要连接的服务器地址与端口
        socket = new WebSocket("ws://172.16.2.19:8686/ws");
        //打开事件 回调方法
        socket.onopen = function() {
            alert("Socket 已打开,连接成功");
            //socket.send("这是来自客户端的消息" + location.href + new Date());
        };
        //获得消息事件
        socket.onmessage = function(msg) {
            //alert(msg.data);
            var msgvalue=msg.data;
            //解析json 字符串 为 json对象
            var obj=JSON.parse(msgvalue);
            if(obj.flag==1){
            	isLogin(msg);	
            	console.log(obj.data);
            	//追加留言板
            	//获取 发送消息时间
            	var sentTime= new Date(obj.date);
            	var prettyTime=sentTime.toLocaleString(); 
            	var con="<div>"+prettyTime+"<hr>"+obj.data+" </div>";
            	$("#content").append(con);
            	//当前在线人数
            	var online="当前在线人数:"+ obj.online;
            	$("#loginpart").append(online);
            }

        };
        //关闭事件
        socket.onclose = function() {
            alert("Socket已关闭");
        };
        //发生了错误事件
        socket.onerror = function() {
            alert("发生了错误");
        }
	} 
    

    //登陆
    $("#btnlogin").click(function(){
        var userName=$("#userName").val();
        console.log(userName);
        socket.send("userName:"+userName);
    });

    //发送消息
    $("#btnsend").click(function() {
    	var words= $("#word").val();
        //socket.send("这是来自客户端的消息" + location.href + new Date()+words);
        socket.send(words);
        //jquery 修改html对象的属性。
        $("#word").val("");
    });


    //消息内容流
    function addMessage(result){
    	var message=result.data;
    }

    //注销登录
    $("#logout").click(function(){
    	socket.close();
    });

    //判断是否登录成功？
    function isLogin(message){
    	var message=message.data;
    	if (message!='登录失败'||message!=undefined) {
    		$("#loginpart").empty();
    		$("#loginpart").append(message);
    		return true;
    	}else{
    		return false;
    	}
    }
    
</script>

</body>
</html>